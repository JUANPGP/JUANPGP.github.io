<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Festival Central Tier System</title>
  <link rel="icon" href="img/logo.png" />
  <style>
    :root {
      --bg: #1f1f25;
      --card: #2f2f3a;
      --muted: #888;
      --radius: 12px;
      --transition: .2s;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #272935 80%;
      color: #f5f5f8;
      min-height: 100vh;
      padding: 16px;
    }

    h1 {
      margin-top: 0;
      font-size: 1.6rem;
    }

    .container {
      max-width: 600px;
      margin: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .card {
      background: var(--card);
      border-radius: var(--radius);
      padding: 16px;
      position: relative;
      display: flex;
      flex-direction: column;
      gap: 10px;
      box-shadow: 0 12px 30px -5px rgba(0, 0, 0, .4);
    }

    label {
      font-size: .8rem;
      text-transform: uppercase;
      letter-spacing: .5px;
      margin-bottom: 6px;
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }

    select,
    input {
      flex: 1 1 100%;
      padding: 12px 14px;
      border-radius: 8px;
      border: none;
      background: #23232d;
      color: #f5f5f8;
      font-size: 1rem;
      appearance: none;
    }

    input::placeholder {
      color: #999;
    }

    button {
      padding: 14px;
      border: none;
      background: #6366f1;
      color: #fff;
      font-size: 1rem;
      border-radius: 8px;
      cursor: pointer;
      width: 100%;
      transition: var(--transition);
    }

    button:active {
      transform: scale(.98);
    }

    button:hover {
      filter: brightness(1.05);
    }

    .result-box {
      background: #1f2330;
      border: 1px solid rgba(255, 255, 255, .08);
      border-radius: 8px;
      padding: 14px;
      font-size: 1rem;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .small {
      font-size: .8rem;
      color: var(--muted);
    }

    .inline {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .table-wrap {
      overflow: auto;
      margin-top: 12px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    @media screen and (min-width: 601px) {
      table {
        min-width: 540px;
      }
    }


    th,
    td {
      padding: 10px 8px;
      text-align: left;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      border-right: 1px solid rgba(255, 255, 255, 0.1);
    }

    th:last-child,
    td:last-child {
      border-left: none;
      border-right: none;
    }

    thead th {
      color: #dfe6ff;
      font-size: 0.85rem;
      position: sticky;
      top: 0;
      z-index: 2;
    }

    .icon {
      width: 42px;
      height: 42px;
      object-fit: contain;
      vertical-align: text-top;
    }

    .tabs {
      display: flex;
      gap: 12px;
      margin-bottom: 12px;
    }

    .tab {
      flex: 1;
      padding: 12px;
      background: #23232d;
      border: none;
      border-radius: 8px;
      color: #f5f5f8;
      cursor: pointer;
      transition: .2s;
    }

    .tab-content {
      display: none;
      flex-direction: column;
      gap: 16px;
    }

    .tab-content.active {
      display: flex;
    }


    .tab.active {
      background: #6366f1;
      font-weight: bold;
    }

    @media (min-width:800px) {
      .grid-2 {
        display: grid;
        grid-template-columns: 1fr 360px;
        gap: 12px;
        align-items: start;
      }
    }

    @media (max-width:799px) {
      .container {
        padding: 12px;
      }

      .card {
        padding: 12px;
      }
    }
  </style>
</head>

<body>
  <div class="container">

    <div class="tabs">
      <button class="tab active" data-target="scoreCard">Score Calculator</button>
      <button class="tab" data-target="difficultyCard">Song Difficulty List</button>
      <button class="tab" data-target="fpGoalCard">FP Goal Calculator</button>
    </div>

    <div class="card tab-content active" id="scoreCard">
      <h1>Score Calculator</h1>
      <div class="row">
        <div style="flex:1">
          <label for="songInput">Song</label>
          <input list="songList" id="songInput" placeholder="Type or select song" autocomplete="off" />
          <datalist id="songList"></datalist>
        </div>
        <div style="flex:1">
          <label for="instrumentSelect">Instrument</label>
          <select id="instrumentSelect">
            <option value="">-- Select --</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div style="flex:1">
          <label for="perfects">Perfect Notes</label>
          <input type="number" id="perfects" placeholder="e.g., 1234" min="0" />
        </div>
      </div>
      <button id="calcBtn">Calculate Score</button>
      <div id="result" class="result-box" aria-live="polite">
        <div class="small">Enter song, instrument and perfect notes to get score.</div>
      </div>
    </div>

    <div class="card tab-content" id="difficultyCard">
      <h1>Song Difficulty List</h1>
      <div class="row" style="align-items:end; gap: 10px;">
        <div style="width:100px;">
          <label for="filterInstrument">Instrument</label>
          <select id="filterInstrument">
            <option value="">All</option>
            <option value="Vocals">Vocals</option>
            <option value="Bass">Bass</option>
            <option value="Lead">Lead</option>
            <option value="Drums">Drums</option>
          </select>
        </div>
        <div style="width:110px;">
          <label for="filterDifficulty">Difficulty</label>
          <select id="filterDifficulty">
            <option value="">-- Any --</option>
            <option value="0.1">0.1</option>
            <option value="0.2">0.2</option>
            <option value="0.3">0.3</option>
            <option value="0.4">0.4</option>
            <option value="0.5">0.5</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="7">7</option>
            <option value="8">8</option>
            <option value="9">9</option>
            <option value="10">10</option>
            <option value="12">12</option>
          </select>
        </div>
        <div style="width:190px;">
          <label for="filterMode">Filter Type</label>
          <select id="filterMode">
            <option value="exact">Exact</option>
            <option value="gte">Greater or equal (≥)</option>
          </select>
        </div>
      </div>
      <div class="table-wrap" style="margin-top:12px;">
        <table id="difficultyTable" aria-label="Song difficulty table">
          <thead>
            <tr>
              <th style="width:80px">Instrument</th>
              <th>Songs</th>
              <th style="width:120px;text-align:center">Difficulty</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="card tab-content" id="fpGoalCard">
      <h1>FP Goal Calculator</h1>
      <div class="row">
        <div style="flex:1">
          <label for="fpInput">Desired FP</label>
          <input type="number" id="fpInput" placeholder="e.g., 82" min="1" />
        </div>
      </div>
      <button id="fpCalcBtn">Find Songs</button>
      <div id="result" class="result-box" aria-live="polite">
        <div class="small">Fun Fact: To achieve the ideal score, you need +85FP on 5 songs rated 8★, +90FP on all 9★, +95FP on all 10★ and +100FP on TTFAF Lead. Only the TOP 2 Players have already reached this score, good luck getting it ;)</div>
      </div>
      <div class="table-wrap">
        <table id="fpTable">
          <thead>
            <tr>
              <th style="width:80px;text-align:center">Instrument</th>
              <th>Song</th>
              <th style="width:120px;text-align:center">Perfect / Goods</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>

    const sheetURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR5zPeo8WDSBx8igMIj_EwbXOwV3QoFO4c9q3LDJLDiTvgvUwDeFp3xH7jlGCJUmbkjhjK8jnLp4cFp/pub?gid=728145224&single=true&output=csv";
    const localCSV = "songs.csv";

    // Tabs handler
    document.querySelectorAll(".tab").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".tab").forEach(b => b.classList.remove("active"));
        document.querySelectorAll(".tab-content").forEach(c => c.classList.remove("active"));
        btn.classList.add("active");
        document.getElementById(btn.dataset.target).classList.add("active");
      });
    });

    const rawBonus = {
      100: 1,
      99: 0.99,
      98: 0.96,
      97: 0.93,
      96: 0.89,
      95: 0.87,
      94: 0.85,
      93: 0.8,
      92: 0.75,
      91: 0.7,
      90: 0.65,
      89: 0.6,
      88: 0.55,
      87: 0.5,
      86: 0.45,
      85: 0.4,
      84: 0.35,
      83: 0.3,
      82: 0.25,
      81: 0.18,
      80: 0.10,
      70: 0.0875,
      60: 0.075,
      50: 0.0625,
      40: 0.05,
      30: 0.0375,
      20: 0.025,
      10: 0.0125
    };

    const bonusKeys = Object.keys(rawBonus).map(k => parseFloat(k)).sort((a, b) => a - b);

    function getInterpolatedBonus(pct) {
      if (isNaN(pct)) return 0;
      const highest = bonusKeys[bonusKeys.length - 1];
      const lowest = bonusKeys[0];
      if (pct >= highest) return rawBonus[highest];
      if (pct <= lowest) return rawBonus[lowest];
      let lower = lowest, upper = highest;
      for (let i = 0; i < bonusKeys.length - 1; i++) {
        if (pct >= bonusKeys[i] && pct <= bonusKeys[i + 1]) { lower = bonusKeys[i]; upper = bonusKeys[i + 1]; break; }
      }
      const bonusLower = rawBonus[lower], bonusUpper = rawBonus[upper];
      const weight = (pct - lower) / (upper - lower);
      return bonusLower + weight * (bonusUpper - bonusLower);
    }

    function normalizeKey(k) { return (k || "").toString().trim().replace(/"/g, ''); }
    function normalizeValue(v) { return (v || "").toString().replace(/"/g, '').trim(); }
    function parseTier(t) {
      if (!t && t !== 0) return NaN;
      const s = normalizeValue(t).replace(',', '.').trim();
      return s === "" ? NaN : parseFloat(s);
    }

    let songsData = [];

    function processSongs(res) {
      songsData = res.data
        .filter(r => r["Title"] && !isNaN(parseInt(r["Vocals Note Ct"])))
        .map(r => ({
          title: normalizeValue(r["Title"]),
          vocalsNotes: parseInt(r["Vocals Note Ct"]),
          bassNotes: parseInt(r["Bass Note Ct"]),
          leadNotes: parseInt(r["Lead Note Ct"]),
          drumsNotes: parseInt(r["Drums Note Ct"]),
          vocalsTier: normalizeValue(r["Vocals Tier"]),
          bassTier: normalizeValue(r["Bass Tier"]),
          leadTier: normalizeValue(r["Lead Tier"]),
          drumsTier: normalizeValue(r["Drums Tier"])
        }));

      populateDatalist();
      renderDifficultyTable();
      console.log("Loaded", songsData.length, "songs");
    }

    function loadSongs() {
      Papa.parse(sheetURL, {
        download: true,
        header: true,
        skipEmptyLines: true,
        transformHeader: h => normalizeKey(h),
        complete: res => processSongs(res),
        error: err => {
          console.warn("Google Sheets failed, loading local CSV:", err);
          Papa.parse("songs.csv", {
            download: true,
            header: true,
            skipEmptyLines: true,
            transformHeader: h => normalizeKey(h),
            complete: res => processSongs(res)
          });
        }
      });
    }

    function populateDatalist(filteredSongs = songsData) {
      const list = document.getElementById("songList");
      list.innerHTML = "";
      filteredSongs.forEach(s => {
        const o = document.createElement("option");
        o.value = s.title;
        list.appendChild(o);
      });
    }

    function findSong(title) {
      return songsData.find(s => s.title.toLowerCase() === title.toLowerCase());
    }

    function updateInstrumentOptions(song) {
      const instSel = document.getElementById("instrumentSelect");
      instSel.innerHTML = '<option value="">-- Select --</option>';
      if (!song) return;
      if (typeof song.vocalsNotes === "number" && !isNaN(song.vocalsNotes) && song.vocalsNotes > 0) {
        const o = document.createElement("option"); o.value = "Vocals"; o.textContent = "Vocals"; instSel.appendChild(o);
      }
      if (typeof song.bassNotes === "number" && !isNaN(song.bassNotes) && song.bassNotes > 0) {
        const o = document.createElement("option"); o.value = "Bass"; o.textContent = "Bass"; instSel.appendChild(o);
      }
      if (typeof song.leadNotes === "number" && !isNaN(song.leadNotes) && song.leadNotes > 0) {
        const o = document.createElement("option"); o.value = "Lead"; o.textContent = "Lead"; instSel.appendChild(o);
      }
      if (typeof song.drumsNotes === "number" && !isNaN(song.drumsNotes) && song.drumsNotes > 0) {
        const o = document.createElement("option"); o.value = "Drums"; o.textContent = "Drums"; instSel.appendChild(o);
      }
    }

    document.getElementById("songInput").addEventListener("input", e => {
      const val = e.target.value.trim().toLowerCase();
      const filtered = songsData.filter(s =>
        s.title.toLowerCase().includes(val)
      );
      populateDatalist(filtered);
      const exactMatch = songsData.find(s => s.title.trim().toLowerCase() === val);
      updateInstrumentOptions(exactMatch);
    });

    document.getElementById("calcBtn").addEventListener("click", () => {
      const songName = document.getElementById("songInput").value.trim();
      const instrument = document.getElementById("instrumentSelect").value;
      const perfects = Number(document.getElementById("perfects").value);
      const resultBox = document.getElementById("result");
      if (!songName || !instrument || isNaN(perfects) || perfects < 0) {
        resultBox.innerHTML = '<div class="small">Missing or invalid input.</div>';
        return;
      }
      const song = findSong(songName);
      if (!song) {
        resultBox.innerHTML = '<div class="small">Song not found. Check spelling.</div>';
        return;
      }
      let total = 0, tier;
      if (instrument === "Vocals") { total = song.vocalsNotes; tier = song.vocalsTier; }
      if (instrument === "Bass") { total = song.bassNotes; tier = song.bassTier; }
      if (instrument === "Lead") { total = song.leadNotes; tier = song.leadTier; }
      if (instrument === "Drums") { total = song.drumsNotes; tier = song.drumsTier; }

      const tierNum = parseTier(tier);
      if (!total || isNaN(tierNum)) {
        resultBox.innerHTML = '<div class="small">Instrument or tier missing.</div>';
        return;
      }

      const precision = perfects / total;
      const pct = precision * 100;
      const bonus = getInterpolatedBonus(pct);

      const diffVal = (function mapTierToValue(t) {
        switch (t) {
          case 0.1: return 5;
          case 0.2: return 10;
          case 0.3: return 20;
          case 0.4: return 30;
          case 0.5: return 40;
          case 1: return 50;
          case 2: return 58;
          case 3: return 65;
          case 4: return 70;
          case 5: return 75;
          case 6: return 80;
          case 7: return 85;
          case 8: return 90;
          case 9: return 95;
          case 10: return 100;
          case 12: return 110;
          default: return 0;
        }
      })(tierNum);

      const score = diffVal * precision * bonus;

      resultBox.innerHTML = `
    <div><strong>Score:</strong> ${isFinite(score) ? score.toFixed(2) : 'N/A'}</div>
    <div class="small">Accuracy: ${isFinite(pct) ? pct.toFixed(2) + '%' : 'N/A'}</div>
    <div class="small">Bonus: ${isFinite(bonus) ? bonus.toFixed(4) : 'N/A'}</div>
    <div class="small">Difficulty value: ${diffVal}</div>
    <div class="small">Perfects: ${perfects} / ${total}</div>
    `;
    });

    function renderDifficultyTable() {
      const tbody = document.querySelector("#difficultyTable tbody");
      tbody.innerHTML = "";
      let entries = [];
      songsData.forEach(s => {
        if (!isNaN(parseTier(s.vocalsTier))) entries.push({ instrument: "Vocals", difficulty: parseTier(s.vocalsTier), title: s.title });
        if (!isNaN(parseTier(s.bassTier))) entries.push({ instrument: "Bass", difficulty: parseTier(s.bassTier), title: s.title });
        if (!isNaN(parseTier(s.leadTier))) entries.push({ instrument: "Lead", difficulty: parseTier(s.leadTier), title: s.title });
        if (!isNaN(parseTier(s.drumsTier))) entries.push({ instrument: "Drums", difficulty: parseTier(s.drumsTier), title: s.title });
      });

      const instrFilter = document.getElementById("filterInstrument").value;
      const diffFilterStr = document.getElementById("filterDifficulty").value;
      const filterMode = document.getElementById("filterMode").value;

      let diffFilter = diffFilterStr === "" ? null : parseFloat(diffFilterStr);

      let filtered = entries.filter(e => {
        if (instrFilter && e.instrument !== instrFilter) return false;
        if (diffFilter !== null) {
          if (filterMode === "exact") return Number(e.difficulty) === Number(diffFilter);
          if (filterMode === "gte") return Number(e.difficulty) >= Number(diffFilter);
        }
        return true;
      });

      filtered.sort((a, b) => {
        if (b.difficulty !== a.difficulty) return (b.difficulty - a.difficulty);
        return a.title.localeCompare(b.title);
      });

      filtered.forEach(row => {
        const tr = document.createElement("tr");
        const iconPath = `img/${row.instrument.toLowerCase()}.png`;
        const iconHtml = `<img class="icon" src="${iconPath}" alt="${row.instrument}">`;
        tr.innerHTML = `<td style="text-align:center">${iconHtml}</td><td>${escapeHtml(row.title)}</td><td style="text-align:center">${row.difficulty}</td>`;
        tbody.appendChild(tr);
      });
    }

    function escapeHtml(s) { return (s || '').toString().replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' }[c])); }

    document.getElementById("filterInstrument").addEventListener("change", renderDifficultyTable);
    document.getElementById("filterDifficulty").addEventListener("input", renderDifficultyTable);
    document.getElementById("filterMode").addEventListener("change", renderDifficultyTable);

    document.getElementById("filterInstrument").addEventListener("change", renderDifficultyTable);
    document.getElementById("filterMode").addEventListener("change", renderDifficultyTable);

    loadSongs();

    // FP Goal
    function round2(n) { return Math.round(n * 100) / 100; }

    function tierToFP(t) {
      switch (t) {
        case 0.1: return 5;
        case 0.2: return 10;
        case 0.3: return 20;
        case 0.4: return 30;
        case 0.5: return 40;
        case 1: return 50;
        case 2: return 58;
        case 3: return 65;
        case 4: return 70;
        case 5: return 75;
        case 6: return 80;
        case 7: return 85;
        case 8: return 90;
        case 9: return 95;
        case 10: return 100;
        case 12: return 110;
        default: return 0;
      }
    }

    function findMinimalPerfectsForFP(song, instrument, desiredFP) {
      let totalNotes = 0;
      let tierNum = NaN;
      if (instrument === "Vocals") { totalNotes = song.vocalsNotes; tierNum = parseTier(song.vocalsTier); }
      if (instrument === "Bass") { totalNotes = song.bassNotes; tierNum = parseTier(song.bassTier); }
      if (instrument === "Lead") { totalNotes = song.leadNotes; tierNum = parseTier(song.leadTier); }
      if (instrument === "Drums") { totalNotes = song.drumsNotes; tierNum = parseTier(song.drumsTier); }

      if (!totalNotes || isNaN(tierNum)) return null;
      const baseFP = tierToFP(tierNum);
      if (baseFP <= 0) return null;

      for (let p = 0; p <= totalNotes; p++) {
        const precision = p / totalNotes;
        const pct = precision * 100;
        const bonus = getInterpolatedBonus(pct);
        const score = baseFP * precision * bonus;
        const scoreRounded = round2(score);
        if (scoreRounded >= desiredFP) {
          return { perfects: p, goods: totalNotes - p, totalNotes, tier: tierNum };
        }
      }
      return null;
    }

    document.getElementById("fpCalcBtn").addEventListener("click", () => {
      const desiredFP = Number(document.getElementById("fpInput").value);
      const tbody = document.querySelector("#fpTable tbody");
      tbody.innerHTML = "";

      if (isNaN(desiredFP) || desiredFP <= 0) {
        tbody.innerHTML = `<tr><td colspan="3" style="text-align:center">Enter a valid FP</td></tr>`;
        return;
      }

      const resultsByTier = {};
      songsData.forEach(song => {
        ["Vocals", "Bass", "Lead", "Drums"].forEach(inst => {
          const req = findMinimalPerfectsForFP(song, inst, desiredFP);
          if (!req) return;
          if (!resultsByTier[req.tier]) resultsByTier[req.tier] = [];
          resultsByTier[req.tier].push({
            instrument: inst,
            song: song.title,
            perfects: req.perfects,
            goods: req.goods,
            totalNotes: req.totalNotes,
            tier: req.tier
          });
        });
      });

      const tiers = Object.keys(resultsByTier)
        .map(k => parseFloat(k))
        .sort((a, b) => b - a);

      if (tiers.length === 0) {
        tbody.innerHTML = `<tr><td colspan="3" style="text-align:center">No matching songs found</td></tr>`;
        return;
      }

      const allGroups = [];
      const songRows = [];

      tiers.forEach(t => {
        const baseFP = tierToFP(t);
        const results = resultsByTier[t];
        const allArePFC = results.every(r => r.perfects === r.totalNotes);
        const isExactPFC = desiredFP === baseFP;

        if (allArePFC && isExactPFC) {
          const title = Number.isInteger(t) ? `All ${t}★ Songs` : `All ${t} Songs`;
          allGroups.push(`
            <tr>
              <td style="text-align:center"><img class="icon" src="img/all.png" alt="All"></td>
              <td><strong>${escapeHtml(title)}</strong></td>
              <td style="text-align:center">PFC (100%)</td>
            </tr>
          `);
        } else {
          const sample = results[0];
          const pct = ((sample.perfects / sample.totalNotes) * 100).toFixed(2);
          songRows.push(`
          <tr>
            <td colspan="3" style="background:#2f2f3a; font-weight:bold; text-align:center; padding:8px; border-top:2px solid #6366f1; border-bottom:2px solid #6366f1;">
            Tier ${t} - ${pct}%
            </td>
          </tr>
        `);
          results.sort((a, b) => a.song.localeCompare(b.song));
          results.forEach(r => {
            const iconPath = `img/${r.instrument.toLowerCase()}.png`;
            songRows.push(`
              <tr>
                <td style="text-align:center"><img class="icon" src="${iconPath}" alt="${r.instrument}"></td>
                <td>${escapeHtml(r.song)}</td>
                <td style="text-align:center">${r.goods === 0 ? "PFC" : `${r.perfects} / ${r.goods}`}</td>
              </tr>
            `);
          });
        }
      });
      tbody.innerHTML = allGroups.join("") + songRows.join("");
    });

  </script>
</body>

</html>
